<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.lug.ustc.edu.cn/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.5.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="plugin," />





  <link rel="alternate" href="/atom.xml" title="zjutkz's blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.5.0" />






<meta name="description" content="现如今插件化的思想和应用在Android上越来越多了，各式各样的方案也是层出不穷，这篇文章旨在告诉大家插件化的核心思想是什么，又有什么样的实现方式。">
<meta property="og:type" content="article">
<meta property="og:title" content="让我们来聊一聊插件化吧">
<meta property="og:url" content="http://zjutkz.net/2016/05/06/让我们来聊一聊插件化吧/index.html">
<meta property="og:site_name" content="zjutkz's blog">
<meta property="og:description" content="现如今插件化的思想和应用在Android上越来越多了，各式各样的方案也是层出不穷，这篇文章旨在告诉大家插件化的核心思想是什么，又有什么样的实现方式。">
<meta property="og:updated_time" content="2016-05-08T10:55:01.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="让我们来聊一聊插件化吧">
<meta name="twitter:description" content="现如今插件化的思想和应用在Android上越来越多了，各式各样的方案也是层出不穷，这篇文章旨在告诉大家插件化的核心思想是什么，又有什么样的实现方式。">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: undefined,
      author: '博主'
    }
  };
</script>

  <title> 让我们来聊一聊插件化吧 | zjutkz's blog </title>
</head>


     <!-- custom analytics part create by xiamo -->
<script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
<script>AV.initialize("NW3PqfRBQc5fFTl1qj3NHoIz-gzGzoHsz", "6yROqDeLiKrgr5XOqHenkt7m");</script>
<script>
function showTime(Counter) {
	var query = new AV.Query(Counter);
	$(".leancloud_visitors").each(function() {
		var url = $(this).attr("id").trim();
		query.equalTo("url", url);
		query.find({
			success: function(results) {
				if (results.length == 0) {
					var content = $(document.getElementById(url)).text() + ': 0';
					$(document.getElementById(url)).text(content);
					return;
				}
				for (var i = 0; i < results.length; i++) {
					var object = results[i];
					var content = $(document.getElementById(url)).text() + ': ' + object.get('time');
					$(document.getElementById(url)).text(content);
				}
			},
			error: function(object, error) {
				console.log("Error: " + error.code + " " + error.message);
			}
		});

	});
}

function addCount(Counter) {
	var Counter = AV.Object.extend("Counter");
	url = $(".leancloud_visitors").attr('id').trim();
	title = $(".leancloud_visitors").attr('data-flag-title').trim();
	var query = new AV.Query(Counter);
	query.equalTo("url", url);
	query.find({
		success: function(results) {
			if (results.length > 0) {
				var counter = results[0];
				counter.fetchWhenSave(true);
				counter.increment("time");
				counter.save(null, {
					success: function(counter) {
						var content = $(document.getElementById(url)).text() + ': ' + counter.get('time');
						$(document.getElementById(url)).text(content);
					},
					error: function(counter, error) {
						console.log('Failed to save Visitor num, with error message: ' + error.message);
					}
				});
			} else {
				var newcounter = new Counter();
				newcounter.set("title", title);
				newcounter.set("url", url);
				newcounter.set("time", 1);
				newcounter.save(null, {
					success: function(newcounter) {
					    console.log("newcounter.get('time')="+newcounter.get('time'));
						var content = $(document.getElementById(url)).text() + ': ' + newcounter.get('time');
						$(document.getElementById(url)).text(content);
					},
					error: function(newcounter, error) {
						console.log('Failed to create');
					}
				});
			}
		},
		error: function(error) {
			console.log('Error:' + error.code + " " + error.message);
		}
	});
}
$(function() {
	var Counter = AV.Object.extend("Counter");
	if ($('.leancloud_visitors').length == 1) {
		addCount(Counter);
	} else if ($('.post-title-link').length > 1) {
		showTime(Counter);
	}
}); 
</script>


<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">zjutkz's blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">try everything</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-rss">
          <a href="/atom.xml" rel="section">
            
              <i class="menu-item-icon fa fa-rss fa-fw"></i> <br />
            
            rss订阅
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                让我们来聊一聊插件化吧
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-06T15:28:32+08:00" content="2016-05-06">
              2016-05-06
            </time>
          </span>

          

          
            
          

          

          
          
             <span id="/2016/05/06/让我们来聊一聊插件化吧/" class="leancloud_visitors" data-flag-title="让我们来聊一聊插件化吧">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>现如今插件化的思想和应用在Android上越来越多了，各式各样的方案也是层出不穷，这篇文章旨在告诉大家插件化的核心思想是什么，又有什么样的实现方式。</p>
<a id="more"></a>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>首先，这篇文章的题目为什么不沿用我之前xxxx！xxxxx这样的风格呢，因为我觉得这样风格太中二了。。</p>
<p>其次，我写这篇文章的原因是因为前些时候看到有大神写了一篇文章<a href="http://kymjs.com/code/2016/05/04/01" target="_blank" rel="external">Android 插件化的 过去 现在 未来</a>，里面的内容很不错，特别是有一些关于原理的东西，让我回想起当时看几个插件化框架的源码的时候产生的心得和体会，这里也是写出来给大家做一个分享吧。</p>
<h1 id="插件化介绍"><a href="#插件化介绍" class="headerlink" title="插件化介绍"></a>插件化介绍</h1><p>在开始真正讲解插件化之前，让我先告诉那些不了解插件化是什么的同学［什么是插件化］。</p>
<p>所谓插件化，就是让我们的应用不必再像原来一样把所有的内容都放在一个apk中，可以把一些功能和逻辑单独抽出来放在插件apk中，然后主apk做到［按需调用］，这样的好处是一来可以减少主apk的体积，让应用更轻便，二来可以做到热插拔，更加动态化。</p>
<p>在后文中，我首先会对插件化的实现原理进行一个分析，接着我挑了其中两个比较有代表性的，［Small］和［DroidPlugin］来分析他们的实现有什么区别。</p>
<h1 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h1><p>在分析原理之前，让我们先想想做插件化会遇到的挑战。大家可以想一想，如果我要做一个插件apk，里面会包含什么？首先想到的肯定是activity和对应的资源，我们要做的事就是在主apk中调用插件apk中的activity，并且加载对应的资源。当然这只是其中的一个挑战，这里我不会带大家分析所有的原理，因为这样一天一夜都讲不完，所以我选取了其中最具代表性的一点：［主apk如何加载插件apk中的activity］。</p>
<p>首先，我们回想一下平时我们是怎么唤起一个activity的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Intent intent = <span class="keyword">new</span> Intent(ActivityA.<span class="keyword">this</span>,ActivityB.class);</span><br><span class="line">startActivity(intent);</span><br></pre></td></tr></table></figure>
<p>我们调用的是activity的startActivity方法，而我们都知道我们的activity是继承自ContextThemeWrapper的，而ContextThemeWrapper只是一个包装类，真正的逻辑在ContextImpl中，让我们看看其中做了什么。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent, Bundle options)</span> </span>&#123;</span><br><span class="line">    warnIfCallingFromSystemProcess();</span><br><span class="line">    <span class="keyword">if</span> ((intent.getFlags()&amp;Intent.FLAG_ACTIVITY_NEW_TASK) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AndroidRuntimeException(</span><br><span class="line">                <span class="string">"Calling startActivity() from outside of an Activity "</span></span><br><span class="line">                + <span class="string">" context requires the FLAG_ACTIVITY_NEW_TASK flag."</span></span><br><span class="line">                + <span class="string">" Is this really what you want?"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mMainThread.getInstrumentation().execStartActivity(</span><br><span class="line">        getOuterContext(), mMainThread.getApplicationThread(), <span class="keyword">null</span>,</span><br><span class="line">        (Activity)<span class="keyword">null</span>, intent, -<span class="number">1</span>, options);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中调用了mMainThread.getInstrumentation()获取一个Instrumentation对象，这个对象大家可以看作是activity的管家，对activity的操作都会调用它去执行。让我们看看它的execStartActivity方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ActivityResult <span class="title">execStartActivity</span><span class="params">(Context who, IBinder contextThread, IBinder token, Activity target,</span><br><span class="line">        Intent intent, <span class="keyword">int</span> requestCode, Bundle options)</span> </span>&#123;</span><br><span class="line">    IApplicationThread whoThread = (IApplicationThread) contextThread;</span><br><span class="line">    <span class="keyword">if</span> (mActivityMonitors != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mSync) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> N = mActivityMonitors.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> ActivityMonitor am = mActivityMonitors.get(i);</span><br><span class="line">                <span class="keyword">if</span> (am.match(who, <span class="keyword">null</span>, intent)) &#123;</span><br><span class="line">                    am.mHits++;</span><br><span class="line">                    <span class="keyword">if</span> (am.isBlocking()) &#123;</span><br><span class="line">                        <span class="keyword">return</span> requestCode &gt;= <span class="number">0</span> ? am.getResult() : <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        intent.migrateExtraStreamToClipData();</span><br><span class="line">        intent.prepareToLeaveProcess();</span><br><span class="line">        <span class="keyword">int</span> result = ActivityManagerNative.getDefault()</span><br><span class="line">            .startActivity(whoThread, who.getBasePackageName(), intent,</span><br><span class="line">                    intent.resolveTypeIfNeeded(who.getContentResolver()),</span><br><span class="line">                    token, target != <span class="keyword">null</span> ? target.mEmbeddedID : <span class="keyword">null</span>,</span><br><span class="line">                    requestCode, <span class="number">0</span>, <span class="keyword">null</span>, options);</span><br><span class="line">        checkStartActivityResult(result, intent);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法最关键的一点就是调用了ActivityManagerNative.getDefault()去获取一个ActivityManagerNative对象并且调用了它的startActivity方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityManagerNative</span> <span class="keyword">extends</span> <span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">IActivityManager</span></span></span><br></pre></td></tr></table></figure>
<p>从它的定义就可以看出它是和aidl相关的，对于aidl这里我不细讲，大家可以自行查阅相关资料，概括来说就是Android中一种跨进程的通信方式。</p>
<p>那既然是跨进程的，通过ActivityManagerNative跨到了哪个进程呢？答案是ActivityManagerService，简称AMS，它是ActivityManagerNative的实现类。是Android framework层最最最重要的几个类之一，是运行在Android内核进程的。下面让我们看看AMS的startActivity方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage,</span><br><span class="line">        Intent intent, String resolvedType, IBinder resultTo,</span><br><span class="line">        String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> startFlags,</span><br><span class="line">        String profileFile, ParcelFileDescriptor profileFd, Bundle options)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> startActivityAsUser(caller, callingPackage, intent, resolvedType, resultTo,</span><br><span class="line">            resultWho, requestCode,</span><br><span class="line">            startFlags, profileFile, profileFd, options, UserHandle.getCallingUserId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到调用了startActivityAsUser。而在startActivityAsUser方法中调用了ActivityStackSupervisor的startActivityMayWait方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityMayWait</span><span class="params">(IApplicationThread caller, <span class="keyword">int</span> callingUid,String callingPackage, Intent intent, String resolvedType, IBinder resultTo,String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> startFlags, String profileFile,</span><br><span class="line">ParcelFileDescriptor profileFd, WaitResult outResult, Configuration config,Bundle options, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">     ..........</span><br><span class="line"></span><br><span class="line">     <span class="keyword">int</span> res = startActivityLocked(caller, intent, resolvedType,aInfo, resultTo, resultWho, requestCode, callingPid, callingUid,callingPackage, startFlags, options, componentSpecified, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    .........</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法内容很多，前面主要是对一些权限的判断，这个我们等等再讲，而在判断完权限之后，调用了startActivityLocked方法。</p>
<p>在调用了startActivityLocked方法之后，是一系列和ActivityStack这个类的交互，这其中的过程我这里不分析了，从ActivityStack这个类的名字就可以看出它是和Activity栈相关的，交互的主要目的也就是处理activity栈的需求。最后会调用到realStartActivityLocked方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">realStartActivityLocked</span><span class="params">(ActivityRecord r,ProcessRecord app, <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span></span><br><span class="line">        <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line"></span><br><span class="line">    r.startFreezingScreenLocked(app, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">false</span>) Slog.d(TAG, <span class="string">"realStartActivity: setting app visibility true"</span>);</span><br><span class="line">    mWindowManager.setAppVisibility(r.appToken, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// schedule launch ticks to collect information about slow apps.</span></span><br><span class="line">    r.startLaunchTickingLocked();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Have the window manager re-evaluate the orientation of</span></span><br><span class="line">    <span class="comment">// the screen based on the new activity order.  Note that</span></span><br><span class="line">    <span class="comment">// as a result of this, it can call back into the activity</span></span><br><span class="line">    <span class="comment">// manager with a new orientation.  We don't care about that,</span></span><br><span class="line">    <span class="comment">// because the activity is not currently running so we are</span></span><br><span class="line">    <span class="comment">// just restarting it anyway.</span></span><br><span class="line">    <span class="keyword">if</span> (checkConfig) &#123;</span><br><span class="line">        Configuration config = mWindowManager.updateOrientationFromAppTokens(</span><br><span class="line">                mService.mConfiguration,</span><br><span class="line">                r.mayFreezeScreenLocked(app) ? r.appToken : <span class="keyword">null</span>);</span><br><span class="line">        mService.updateConfigurationLocked(config, r, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r.app = app;</span><br><span class="line">    app.waitingToKill = <span class="keyword">null</span>;</span><br><span class="line">    r.launchCount++;</span><br><span class="line">    r.lastLaunchTime = SystemClock.uptimeMillis();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (localLOGV) Slog.v(TAG, <span class="string">"Launching: "</span> + r);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> idx = app.activities.indexOf(r);</span><br><span class="line">    <span class="keyword">if</span> (idx &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        app.activities.add(r);</span><br><span class="line">    &#125;</span><br><span class="line">    mService.updateLruProcessLocked(app, <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> ActivityStack stack = r.task.stack;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (app.thread == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RemoteException();</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;ResultInfo&gt; results = <span class="keyword">null</span>;</span><br><span class="line">        List&lt;Intent&gt; newIntents = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (andResume) &#123;</span><br><span class="line">            results = r.results;</span><br><span class="line">            newIntents = r.newIntents;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_SWITCH) Slog.v(TAG, <span class="string">"Launching: "</span> + r</span><br><span class="line">                + <span class="string">" icicle="</span> + r.icicle</span><br><span class="line">                + <span class="string">" with results="</span> + results + <span class="string">" newIntents="</span> + newIntents</span><br><span class="line">                + <span class="string">" andResume="</span> + andResume);</span><br><span class="line">        <span class="keyword">if</span> (andResume) &#123;</span><br><span class="line">            EventLog.writeEvent(EventLogTags.AM_RESTART_ACTIVITY,</span><br><span class="line">                    r.userId, System.identityHashCode(r),</span><br><span class="line">                    r.task.taskId, r.shortComponentName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r.isHomeActivity() &amp;&amp; r.isNotResolverActivity()) &#123;</span><br><span class="line">            <span class="comment">// Home process is the root process of the task.</span></span><br><span class="line">            mService.mHomeProcess = r.task.mActivities.get(<span class="number">0</span>).app;</span><br><span class="line">        &#125;</span><br><span class="line">        mService.ensurePackageDexOpt(r.intent.getComponent().getPackageName());</span><br><span class="line">        r.sleeping = <span class="keyword">false</span>;</span><br><span class="line">        r.forceNewConfig = <span class="keyword">false</span>;</span><br><span class="line">        mService.showAskCompatModeDialogLocked(r);</span><br><span class="line">        r.compat = mService.compatibilityInfoForPackageLocked(r.info.applicationInfo);</span><br><span class="line">        String profileFile = <span class="keyword">null</span>;</span><br><span class="line">        ParcelFileDescriptor profileFd = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">boolean</span> profileAutoStop = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (mService.mProfileApp != <span class="keyword">null</span> &amp;&amp; mService.mProfileApp.equals(app.processName)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mService.mProfileProc == <span class="keyword">null</span> || mService.mProfileProc == app) &#123;</span><br><span class="line">                mService.mProfileProc = app;</span><br><span class="line">                profileFile = mService.mProfileFile;</span><br><span class="line">                profileFd = mService.mProfileFd;</span><br><span class="line">                profileAutoStop = mService.mAutoStopProfiler;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        app.hasShownUi = <span class="keyword">true</span>;</span><br><span class="line">        app.pendingUiClean = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (profileFd != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                profileFd = profileFd.dup();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (profileFd != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        profileFd.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException o) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                    profileFd = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        app.forceProcessStateUpTo(ActivityManager.PROCESS_STATE_TOP);</span><br><span class="line">        app.thread.scheduleLaunchActivity(<span class="keyword">new</span> Intent(r.intent), r.appToken,</span><br><span class="line">                System.identityHashCode(r), r.info,</span><br><span class="line">                <span class="keyword">new</span> Configuration(mService.mConfiguration), r.compat,</span><br><span class="line">                app.repProcState, r.icicle, results, newIntents, !andResume,</span><br><span class="line">                mService.isNextTransitionForward(), profileFile, profileFd,</span><br><span class="line">                profileAutoStop);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((app.info.flags&amp;ApplicationInfo.FLAG_CANT_SAVE_STATE) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// This may be a heavy-weight process!  Note that the package</span></span><br><span class="line">            <span class="comment">// manager will ensure that only activity can run in the main</span></span><br><span class="line">            <span class="comment">// process of the .apk, which is the only thing that will be</span></span><br><span class="line">            <span class="comment">// considered heavy-weight.</span></span><br><span class="line">            <span class="keyword">if</span> (app.processName.equals(app.info.packageName)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mService.mHeavyWeightProcess != <span class="keyword">null</span></span><br><span class="line">                        &amp;&amp; mService.mHeavyWeightProcess != app) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Starting new heavy weight process "</span> + app</span><br><span class="line">                            + <span class="string">" when already running "</span></span><br><span class="line">                            + mService.mHeavyWeightProcess);</span><br><span class="line">                &#125;</span><br><span class="line">                mService.mHeavyWeightProcess = app;</span><br><span class="line">                Message msg = mService.mHandler.obtainMessage(</span><br><span class="line">                        ActivityManagerService.POST_HEAVY_NOTIFICATION_MSG);</span><br><span class="line">                msg.obj = r;</span><br><span class="line">                mService.mHandler.sendMessage(msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (r.launchFailed) &#123;</span><br><span class="line">            <span class="comment">// This is the second time we failed -- finish activity</span></span><br><span class="line">            <span class="comment">// and give up.</span></span><br><span class="line">            Slog.e(TAG, <span class="string">"Second failure launching "</span></span><br><span class="line">                  + r.intent.getComponent().flattenToShortString()</span><br><span class="line">                  + <span class="string">", giving up"</span>, e);</span><br><span class="line">            mService.appDiedLocked(app, app.pid, app.thread);</span><br><span class="line">            stack.requestFinishActivityLocked(r.appToken, Activity.RESULT_CANCELED, <span class="keyword">null</span>,</span><br><span class="line">                    <span class="string">"2nd-crash"</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This is the first time we failed -- restart process and</span></span><br><span class="line">        <span class="comment">// retry.</span></span><br><span class="line">        app.activities.remove(r);</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r.launchFailed = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (stack.updateLRUListLocked(r)) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Activity "</span> + r</span><br><span class="line">              + <span class="string">" being launched, but already in LRU list"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (andResume) &#123;</span><br><span class="line">        <span class="comment">// As part of the process of launching, ActivityThread also performs</span></span><br><span class="line">        <span class="comment">// a resume.</span></span><br><span class="line">        stack.minimalResumeActivityLocked(r);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// This activity is not starting in the resumed state... which</span></span><br><span class="line">        <span class="comment">// should look like we asked it to pause+stop (but remain visible),</span></span><br><span class="line">        <span class="comment">// and it has done so and reported back the current icicle and</span></span><br><span class="line">        <span class="comment">// other state.</span></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_STATES) Slog.v(TAG, <span class="string">"Moving to STOPPED: "</span> + r</span><br><span class="line">                + <span class="string">" (starting in stopped state)"</span>);</span><br><span class="line">        r.state = ActivityState.STOPPED;</span><br><span class="line">        r.stopped = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Launch the new version setup screen if needed.  We do this -after-</span></span><br><span class="line">    <span class="comment">// launching the initial activity (that is, home), so that it can have</span></span><br><span class="line">    <span class="comment">// a chance to initialize itself while in the background, making the</span></span><br><span class="line">    <span class="comment">// switch back to it faster and look better.</span></span><br><span class="line">    <span class="keyword">if</span> (isFrontStack(stack)) &#123;</span><br><span class="line">        mService.startSetupActivityLocked();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这么长的方法，看的头都晕了，不过没关系，我们看重点的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.thread.scheduleLaunchActivity(<span class="keyword">new</span> Intent(r.intent), r.appToken,System.identityHashCode(r), r.info,<span class="keyword">new</span> Configuration(mService.mConfiguration), r.compat,</span><br><span class="line">app.repProcState, r.icicle, results, newIntents, !andResume,</span><br><span class="line">mService.isNextTransitionForward(), profileFile, profileFd,</span><br><span class="line">profileAutoStop);</span><br></pre></td></tr></table></figure>
<p>重点来了，调用了ApplicationThread的scheduleLaunchActivity方法。大家千万不要被这个类的名字所迷惑了，以为他是一个线程。其实它不仅是线程，还是一个Binder对象，也是和aidl相关的，实现了IApplicationThread接口，定义在ActivityThread类的内部。那我们为什么要用它呢？回想一下，刚刚在Instrumentation里调用了AMS的startActivity之后的所有操作，都是在系统进程中进行的，而现在我们要返回到我们自己的app进程，同样是跨进程，我们需要一个aidl框架去完成，所以这里才会有ApplicationThread。让我们看看具体的方法吧。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleLaunchActivity</span><span class="params">(Intent intent, IBinder token, <span class="keyword">int</span> ident,ActivityInfo info, Configuration curConfig, CompatibilityInfo compatInfo,<span class="keyword">int</span> procState, Bundle state, List&lt;ResultInfo&gt; pendingResults,List&lt;Intent&gt; pendingNewIntents, <span class="keyword">boolean</span> notResumed, <span class="keyword">boolean</span> isForward,String profileName, ParcelFileDescriptor profileFd, <span class="keyword">boolean</span> autoStopProfiler)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        updateProcessState(procState, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        ActivityClientRecord r = <span class="keyword">new</span> ActivityClientRecord();</span><br><span class="line"></span><br><span class="line">        r.token = token;</span><br><span class="line">        r.ident = ident;</span><br><span class="line">        r.intent = intent;</span><br><span class="line">        r.activityInfo = info;</span><br><span class="line">        r.compatInfo = compatInfo;</span><br><span class="line">        r.state = state;</span><br><span class="line"></span><br><span class="line">        r.pendingResults = pendingResults;</span><br><span class="line">        r.pendingIntents = pendingNewIntents;</span><br><span class="line"></span><br><span class="line">        r.startsNotResumed = notResumed;</span><br><span class="line">        r.isForward = isForward;</span><br><span class="line"></span><br><span class="line">        r.profileFile = profileName;</span><br><span class="line">        r.profileFd = profileFd;</span><br><span class="line">        r.autoStopProfiler = autoStopProfiler;</span><br><span class="line"></span><br><span class="line">        updatePendingConfiguration(curConfig);</span><br><span class="line"></span><br><span class="line">        queueOrSendMessage(H.LAUNCH_ACTIVITY, r);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>在最后调用了queueOrSendMessage(H.LAUNCH_ACTIVITY, r)这个方法。</p>
<p>而这里的H其实是一个handler，queueOrSendMessage方法的作用就是通过handler去send一个message。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;    </span><br><span class="line">    <span class="keyword">if</span> (DEBUG_MESSAGES) Slog.v(TAG, <span class="string">"&gt;&gt;&gt; handling: "</span> + codeToString(msg.what));</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">            <span class="keyword">case</span> LAUNCH_ACTIVITY: &#123;</span><br><span class="line">                Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"activityStart"</span>);</span><br><span class="line">                ActivityClientRecord r = (ActivityClientRecord)msg.obj;</span><br><span class="line"></span><br><span class="line">                r.packageInfo = getPackageInfoNoCheck(</span><br><span class="line">                        r.activityInfo.applicationInfo, r.compatInfo);</span><br><span class="line">                handleLaunchActivity(r, <span class="keyword">null</span>);</span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">     ..........</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看H的handleMessage，如果message是我们刚刚发送的LAUNCH_ACTIVITY，则调用handleLaunchActivity方法。而在这个方法中，调用了performLaunchActivity去创建一个Activity。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line"><span class="comment">// System.out.println("##### [" + System.currentTimeMillis() + "] ActivityThread.performLaunchActivity(" + r + ")");</span></span><br><span class="line"></span><br><span class="line">    ActivityInfo aInfo = r.activityInfo;</span><br><span class="line">    <span class="keyword">if</span> (r.packageInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">        r.packageInfo = getPackageInfo(aInfo.applicationInfo, r.compatInfo,</span><br><span class="line">                Context.CONTEXT_INCLUDE_CODE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ComponentName component = r.intent.getComponent();</span><br><span class="line">    <span class="keyword">if</span> (component == <span class="keyword">null</span>) &#123;</span><br><span class="line">        component = r.intent.resolveActivity(</span><br><span class="line">            mInitialApplication.getPackageManager());</span><br><span class="line">        r.intent.setComponent(component);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r.activityInfo.targetActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">        component = <span class="keyword">new</span> ComponentName(r.activityInfo.packageName,</span><br><span class="line">                r.activityInfo.targetActivity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Activity activity = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</span><br><span class="line">        activity = mInstrumentation.newActivity(</span><br><span class="line">                cl, component.getClassName(), r.intent);</span><br><span class="line">        StrictMode.incrementExpectedActivityCount(activity.getClass());</span><br><span class="line">        r.intent.setExtrasClassLoader(cl);</span><br><span class="line">        <span class="keyword">if</span> (r.state != <span class="keyword">null</span>) &#123;</span><br><span class="line">            r.state.setClassLoader(cl);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mInstrumentation.onException(activity, e)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">"Unable to instantiate activity "</span> + component</span><br><span class="line">                + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Application app = r.packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (localLOGV) Slog.v(TAG, <span class="string">"Performing launch of "</span> + r);</span><br><span class="line">        <span class="keyword">if</span> (localLOGV) Slog.v(</span><br><span class="line">                TAG, r + <span class="string">": app="</span> + app</span><br><span class="line">                + <span class="string">", appName="</span> + app.getPackageName()</span><br><span class="line">                + <span class="string">", pkg="</span> + r.packageInfo.getPackageName()</span><br><span class="line">                + <span class="string">", comp="</span> + r.intent.getComponent().toShortString()</span><br><span class="line">                + <span class="string">", dir="</span> + r.packageInfo.getAppDir());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Context appContext = createBaseContextForActivity(r, activity);</span><br><span class="line">            CharSequence title = r.activityInfo.loadLabel(appContext.getPackageManager());</span><br><span class="line">            Configuration config = <span class="keyword">new</span> Configuration(mCompatConfiguration);</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_CONFIGURATION) Slog.v(TAG, <span class="string">"Launching activity "</span></span><br><span class="line">                    + r.activityInfo.name + <span class="string">" with config "</span> + config);</span><br><span class="line">            activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</span><br><span class="line">                    r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">                    r.embeddedID, r.lastNonConfigurationInstances, config);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (customIntent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                activity.mIntent = customIntent;</span><br><span class="line">            &#125;</span><br><span class="line">            r.lastNonConfigurationInstances = <span class="keyword">null</span>;</span><br><span class="line">            activity.mStartedActivity = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">int</span> theme = r.activityInfo.getThemeResource();</span><br><span class="line">            <span class="keyword">if</span> (theme != <span class="number">0</span>) &#123;</span><br><span class="line">                activity.setTheme(theme);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            activity.mCalled = <span class="keyword">false</span>;</span><br><span class="line">            mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">            <span class="keyword">if</span> (!activity.mCalled) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SuperNotCalledException(</span><br><span class="line">                    <span class="string">"Activity "</span> + r.intent.getComponent().toShortString() +</span><br><span class="line">                    <span class="string">" did not call through to super.onCreate()"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            r.activity = activity;</span><br><span class="line">            r.stopped = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (!r.activity.mFinished) &#123;</span><br><span class="line">                activity.performStart();</span><br><span class="line">                r.stopped = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!r.activity.mFinished) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r.state != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!r.activity.mFinished) &#123;</span><br><span class="line">                activity.mCalled = <span class="keyword">false</span>;</span><br><span class="line">                mInstrumentation.callActivityOnPostCreate(activity, r.state);</span><br><span class="line">                <span class="keyword">if</span> (!activity.mCalled) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> SuperNotCalledException(</span><br><span class="line">                        <span class="string">"Activity "</span> + r.intent.getComponent().toShortString() +</span><br><span class="line">                        <span class="string">" did not call through to super.onPostCreate()"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        r.paused = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        mActivities.put(r.token, r);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (SuperNotCalledException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mInstrumentation.onException(activity, e)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">"Unable to start activity "</span> + component</span><br><span class="line">                + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> activity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方法比较长，其中核心的内容是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</span><br><span class="line">        activity = mInstrumentation.newActivity(</span><br><span class="line">                cl, component.getClassName(), r.intent);</span><br><span class="line">        StrictMode.incrementExpectedActivityCount(activity.getClass());</span><br><span class="line">        r.intent.setExtrasClassLoader(cl);</span><br><span class="line">        <span class="keyword">if</span> (r.state != <span class="keyword">null</span>) &#123;</span><br><span class="line">            r.state.setClassLoader(cl);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>又调用了Instrumentation的newActivity去创建一个Activity。</p>
<p>至此，启动一个activity的过程就分析完了，让我们来总结一下。</p>
<p>(1) 我们app中是使用了Activity的startActivity方法，具体调用的是ContextImpl的同名函数。</p>
<p>(2) ContextImpl中会调用Instrumentation的execStartActivity方法。</p>
<p>(3) Instrumentation通过aidl进行跨进程通信，最终调用AMS的startActivity方法。</p>
<p>(4) 在系统进程中AMS中先判断权限，然后通过调用ActivityStackSupervisor和ActivityStack进行一系列的交互用来确定Activity栈的使用方式。</p>
<p>(5) 通过ApplicationThread进行跨进程通信，转回到app进程。</p>
<p>(6) 通过ActivityThread中的H（一个handler）传递消息，最终调用Instrumentation来创建一个Activity。</p>
<p>其实如果大家看过其他有关Android系统的调用，比如启动一个Service之类的，整个过程都是大同小异的，无非就是跨进程和AMS，WMS或者PMS进行通信，然后通过ApplicationThread回到app进程最后通过handler传递消息。</p>
<p>好了，说了这么多，这和我们的插件化有什么关系呢？大家想一想，如果我们要在主apk中启动一个插件apk的Activity，上面的哪一步会出问题？大家好好想一想，想一想，一想，想。。。。</p>
<p>没错！就是(4)，第四步，权限验证会通不过，为啥呢？因为我们主apk的manifest中没有定义插件apk的Activity啊！</p>
<p>让我们回到代码，看看ActivityStackSupervisor的startActivityMayWait方法，关于权限验证的内容都在里面。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; aInfo == <span class="keyword">null</span>) &#123;   </span><br><span class="line">		<span class="comment">// We couldn't find the specific class specified in the Intent.</span></span><br><span class="line">        <span class="comment">// Also the end of the line.</span></span><br><span class="line">        err = ActivityManager.START_CLASS_NOT_FOUND;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (err != ActivityManager.START_SUCCESS) &#123;</span><br><span class="line">            <span class="keyword">if</span> (resultRecord != <span class="keyword">null</span>) &#123;</span><br><span class="line">                resultStack.sendActivityResultLocked(-<span class="number">1</span>,</span><br><span class="line">                    resultRecord, resultWho, requestCode,</span><br><span class="line">                    Activity.RESULT_CANCELED, <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            setDismissKeyguard(<span class="keyword">false</span>);</span><br><span class="line">            ActivityOptions.abort(options);</span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个方法中有这么一段，而在Instrumentation中会去检查这个值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkStartActivityResult</span><span class="params">(<span class="keyword">int</span> res, Object intent)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (res &gt;= ActivityManager.START_SUCCESS) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (res) &#123;</span><br><span class="line">        <span class="keyword">case</span> ActivityManager.START_INTENT_NOT_RESOLVED:</span><br><span class="line">        <span class="keyword">case</span> ActivityManager.START_CLASS_NOT_FOUND:</span><br><span class="line">            <span class="keyword">if</span> (intent <span class="keyword">instanceof</span> Intent &amp;&amp; ((Intent)intent).getComponent() != <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ActivityNotFoundException(</span><br><span class="line">                        <span class="string">"Unable to find explicit activity class "</span></span><br><span class="line">                        + ((Intent)intent).getComponent().toShortString()</span><br><span class="line">                        + <span class="string">"; have you declared this activity in your AndroidManifest.xml?"</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ActivityNotFoundException(</span><br><span class="line">                    <span class="string">"No Activity found to handle "</span> + intent);</span><br><span class="line">        .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果找不到对应的Activity，直接抛出错误。</p>
<p>唔。。怎么办呢？找不到Activity，也许你会觉得直接在主apk的manifest中实现定义就好了，但是这是不可能的，因为你怎么知道插件apk中有什么Activity呢？如果以后要动态的修改插件apk中的Activity，难道你的主apk也要对应的一次次修改吗？</p>
<p>不要慌，办法都是人想出来的，让我们看看Samll和DroidPlugin的解决办法吧。</p>
<h1 id="思考解决方案"><a href="#思考解决方案" class="headerlink" title="思考解决方案"></a>思考解决方案</h1><p>首先我们要明确，要解决的核心问题是［如何能让没有在manifst中注册的Activity能启动起来］。由于权限验证机制是系统做的，我们肯定是没办法修改的，既然我们没办法修改，那是不是考虑去欺骗呢？也就是说可以在manifest中预先定义好几个Activity，俗称占坑，比如名字就叫ActivityA，ActivityB，在校验权限之前把我们插件apk中的Activity替换成定义好的Activity，这样就能顺利通过校验，而在之后真正生成Activity的地方再换回来，瞒天过海。</p>
<p>那怎么去欺骗呢？回归前面的代码，其实答案已经呼之欲出了——我们可以有两种选择，hook Instrumentation或者hook ActivityManagerNative。这也正好对应了Small和DroidPlugin的实现方案。</p>
<h1 id="Small实现方式"><a href="#Small实现方式" class="headerlink" title="Small实现方式"></a>Small实现方式</h1><p>首先，让我们看一下Small的实现方式，大家可以去<a href="https://github.com/wequick/Small" target="_blank" rel="external">它的GitHub</a>上下载源码。</p>
<p>上文提到，Samll的实现方式是hook Instrumentation，让我们从代码上来看，我们看它的ApkBundleLauncher类，它内部有一个setUp方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.setUp(context);</span><br><span class="line">    <span class="comment">// Inject instrumentation</span></span><br><span class="line">    <span class="keyword">if</span> (sHostInstrumentation == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> Class&lt;?&gt; activityThreadClass = Class.forName(<span class="string">"android.app.ActivityThread"</span>);</span><br><span class="line">            <span class="keyword">final</span> Method method = activityThreadClass.getMethod(<span class="string">"currentActivityThread"</span>);</span><br><span class="line">            Object thread = method.invoke(<span class="keyword">null</span>, (Object[]) <span class="keyword">null</span>);</span><br><span class="line">            Field field = activityThreadClass.getDeclaredField(<span class="string">"mInstrumentation"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            sHostInstrumentation = (Instrumentation) field.get(thread);</span><br><span class="line">            Instrumentation wrapper = <span class="keyword">new</span> InstrumentationWrapper();</span><br><span class="line">            field.set(thread, wrapper);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (context <span class="keyword">instanceof</span> Activity) &#123;</span><br><span class="line">                field = Activity.class.getDeclaredField(<span class="string">"mInstrumentation"</span>);</span><br><span class="line">                field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                field.set(context, wrapper);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ignored) &#123;</span><br><span class="line">            ignored.printStackTrace();</span><br><span class="line">            <span class="comment">// Usually, cannot reach here</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到它通过反射获取了Instrumentation并且赋值成了自定义的InstrumentationWrapper。</p>
<p>而在自己定义的InstrumentationWrapper中，会去重写两个重要的方法，那就是execStartActivity和newActivity这两个方法。为什么会选择这两个方法呢？因为我们前面说过，在第一个方法中，系统会去校验权限，而第二个方法则是真正生成Activity实例的方法，我们通过重写两个方法，可以做到我们之前提到的［在execStartActivity的时候把Activity替换成自己的］，而［在newActivity又换回成真正的Activity］，从而做到［欺骗］的效果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@Override</span> V21+</span><br><span class="line"> * Wrap activity from REAL to STUB */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ActivityResult <span class="title">execStartActivity</span><span class="params">(</span><br><span class="line">        Context who, IBinder contextThread, IBinder token, Activity target,</span><br><span class="line">        Intent intent, <span class="keyword">int</span> requestCode, android.os.Bundle options)</span> </span>&#123;</span><br><span class="line">    wrapIntent(intent);</span><br><span class="line">    <span class="keyword">return</span> ReflectAccelerator.execStartActivityV21(sHostInstrumentation,</span><br><span class="line">            who, contextThread, token, target, intent, requestCode, options);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** <span class="doctag">@Override</span> V20-</span><br><span class="line"> * Wrap activity from REAL to STUB */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ActivityResult <span class="title">execStartActivity</span><span class="params">(</span><br><span class="line">        Context who, IBinder contextThread, IBinder token, Activity target,</span><br><span class="line">        Intent intent, <span class="keyword">int</span> requestCode)</span> </span>&#123;</span><br><span class="line">    wrapIntent(intent);</span><br><span class="line">    <span class="keyword">return</span> ReflectAccelerator.execStartActivityV20(sHostInstrumentation,</span><br><span class="line">            who, contextThread, token, target, intent, requestCode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到Wrapper首先根据sdk版本重写了两个不同的方法，这里我们只关注一个就可以，先看wrapIntent方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">wrapIntent</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">    ComponentName component = intent.getComponent();</span><br><span class="line">    <span class="keyword">if</span> (component == <span class="keyword">null</span>) <span class="keyword">return</span>; <span class="comment">// ignore system intent</span></span><br><span class="line"></span><br><span class="line">    String realClazz = intent.getComponent().getClassName();</span><br><span class="line">    <span class="keyword">if</span> (sLoadedActivities == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    ActivityInfo ai = sLoadedActivities.get(realClazz);</span><br><span class="line">    <span class="keyword">if</span> (ai == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Carry the real(plugin) class for incoming `newActivity' method.</span></span><br><span class="line">    intent.addCategory(REDIRECT_FLAG + realClazz);</span><br><span class="line">    String stubClazz = dequeueStubActivity(ai, realClazz);</span><br><span class="line">    intent.setComponent(<span class="keyword">new</span> ComponentName(Small.getContext(), stubClazz));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法的神奇之处在于它先获取了真正的Activity的信息并且保存起来，然后调用了dequeueStubActivity方法去生成一个［占坑］的Activity。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">dequeueStubActivity</span><span class="params">(ActivityInfo ai, String realActivityClazz)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ai.launchMode == ActivityInfo.LAUNCH_MULTIPLE) &#123;</span><br><span class="line">        <span class="comment">// In standard mode, the stub activity is reusable.</span></span><br><span class="line">        <span class="keyword">return</span> STUB_ACTIVITY_PREFIX;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> availableId = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> stubId = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> countForMode = STUB_ACTIVITIES_COUNT;</span><br><span class="line">    <span class="keyword">int</span> countForAll = countForMode * <span class="number">3</span>; <span class="comment">// 3=[singleTop, singleTask, singleInstance]</span></span><br><span class="line">    <span class="keyword">if</span> (mStubQueue == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Lazy init</span></span><br><span class="line">        mStubQueue = <span class="keyword">new</span> String[countForAll];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> offset = (ai.launchMode - <span class="number">1</span>) * countForMode;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; countForMode; i++) &#123;</span><br><span class="line">        String usedActivityClazz = mStubQueue[i + offset];</span><br><span class="line">        <span class="keyword">if</span> (usedActivityClazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (availableId == -<span class="number">1</span>) availableId = i;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (usedActivityClazz.equals(realActivityClazz)) &#123;</span><br><span class="line">            stubId = i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (stubId != -<span class="number">1</span>) &#123;</span><br><span class="line">        availableId = stubId;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (availableId != -<span class="number">1</span>) &#123;</span><br><span class="line">        mStubQueue[availableId + offset] = realActivityClazz;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span></span></span><br><span class="line">        Log.e(TAG, <span class="string">"Launch mode "</span> + ai.launchMode + <span class="string">" is full"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> STUB_ACTIVITY_PREFIX + ai.launchMode + availableId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到其中根据真正的Activity的launchMode等因素生成一个占坑Activity，而这些占坑Activity都是定义在manifest中的。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">application</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Stub Activities --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 1 standard mode --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">".A"</span> <span class="attr">android:launchMode</span>=<span class="string">"standard"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 4 singleTask mode --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">".A10"</span> <span class="attr">android:launchMode</span>=<span class="string">"singleTask"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">".A11"</span> <span class="attr">android:launchMode</span>=<span class="string">"singleTask"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">".A12"</span> <span class="attr">android:launchMode</span>=<span class="string">"singleTask"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">".A13"</span> <span class="attr">android:launchMode</span>=<span class="string">"singleTask"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 4 singleTop mode --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">".A20"</span> <span class="attr">android:launchMode</span>=<span class="string">"singleTop"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">".A21"</span> <span class="attr">android:launchMode</span>=<span class="string">"singleTop"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">".A22"</span> <span class="attr">android:launchMode</span>=<span class="string">"singleTop"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">".A23"</span> <span class="attr">android:launchMode</span>=<span class="string">"singleTop"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 4 singleInstance mode --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">".A30"</span> <span class="attr">android:launchMode</span>=<span class="string">"singleInstance"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">".A31"</span> <span class="attr">android:launchMode</span>=<span class="string">"singleInstance"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">".A32"</span> <span class="attr">android:launchMode</span>=<span class="string">"singleInstance"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">".A33"</span> <span class="attr">android:launchMode</span>=<span class="string">"singleInstance"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Web Activity --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">".webkit.WebActivity"</span></span><br><span class="line">        <span class="attr">android:screenOrientation</span>=<span class="string">"portrait"</span></span><br><span class="line">        <span class="attr">android:windowSoftInputMode</span>=<span class="string">"stateHidden|adjustPan"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;service android:name="net.wequick.small.service.UpgradeService"--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--android:exported="false"/&gt;--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>通过这样的方式我们就顺利的完成了［瞒天过海］的第一步，在之后AMS的权限校验中就能顺利通过了。接着让我们来看newActivity方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="comment">/** Unwrap activity from STUB to REAL */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Activity <span class="title">newActivity</span><span class="params">(ClassLoader cl, String className, Intent intent)</span></span><br><span class="line">        <span class="keyword">throws</span> InstantiationException, IllegalAccessException, ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="comment">// Stub -&gt; Real</span></span><br><span class="line">    <span class="keyword">if</span> (!className.startsWith(STUB_ACTIVITY_PREFIX)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.newActivity(cl, className, intent);</span><br><span class="line">    &#125;</span><br><span class="line">    className = unwrapIntent(intent, className);</span><br><span class="line">    Activity activity = <span class="keyword">super</span>.newActivity(cl, className, intent);</span><br><span class="line">    <span class="keyword">return</span> activity;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">unwrapIntent</span><span class="params">(Intent intent, String className)</span> </span>&#123;</span><br><span class="line">            Set&lt;String&gt; categories = intent.getCategories();</span><br><span class="line">            <span class="keyword">if</span> (categories == <span class="keyword">null</span>) <span class="keyword">return</span> className;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Get plugin activity class name from categories</span></span><br><span class="line">            Iterator&lt;String&gt; it = categories.iterator();</span><br><span class="line">            String realClazz = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">                String category = it.next();</span><br><span class="line">                <span class="keyword">if</span> (category.charAt(<span class="number">0</span>) == REDIRECT_FLAG) &#123;</span><br><span class="line">                    realClazz = category.substring(<span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (realClazz == <span class="keyword">null</span>) <span class="keyword">return</span> className;</span><br><span class="line">            <span class="keyword">return</span> realClazz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里就更简单了，通过unwrapIntent获取真正的Activity并且调用父类的newActivity方法，也就是Instrumentation去生成一个Activity。</p>
<p>到这儿，Small的解决方案就基本讲完了，原理是很简单的，就是通过反射替换掉Instrumentation，然后在里面做文章。</p>
<h1 id="DroidPlugin实现方式"><a href="#DroidPlugin实现方式" class="headerlink" title="DroidPlugin实现方式"></a>DroidPlugin实现方式</h1><p><a href="https://github.com/DroidPluginTeam/DroidPlugin" target="_blank" rel="external">DroidPlugin</a>是另外一种插件化框架，它采取的方案是hook整个ActivityManagerNative。</p>
<p>首先让我们看它其中的IActivityManagerHook类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IActivityManagerHook</span> <span class="keyword">extends</span> <span class="title">ProxyHook</span></span></span><br></pre></td></tr></table></figure>
<p>它继承自ProxyHook。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyHook</span> <span class="keyword">extends</span> <span class="title">Hook</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!isEnable()) &#123;</span><br><span class="line">                <span class="keyword">return</span> method.invoke(mOldObj, args);</span><br><span class="line">            &#125;</span><br><span class="line">            HookedMethodHandler hookedMethodHandler = mHookHandles.getHookedMethodHandler(method);</span><br><span class="line">            <span class="keyword">if</span> (hookedMethodHandler != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> hookedMethodHandler.doHookInner(mOldObj, method, args);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> method.invoke(mOldObj, args);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ...........</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ProxyHook实现了InvocationHandler接口，也就是说它是用于动态代理的，在invoke方法中先通过mHookHandles去获取对应的hookedMethodHandler，这里的mHookHandles在我们对应的情况下是IActivityManagerHookHandle。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IActivityManagerHookHandle</span> <span class="keyword">extends</span> <span class="title">BaseHookHandle</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"startActivity"</span>, <span class="keyword">new</span> startActivity(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"startActivityAsUser"</span>, <span class="keyword">new</span> startActivityAsUser(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"startActivityAsCaller"</span>, <span class="keyword">new</span> startActivityAsCaller(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"startActivityAndWait"</span>, <span class="keyword">new</span> startActivityAndWait(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"startActivityWithConfig"</span>, <span class="keyword">new</span> startActivityWithConfig(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"startActivityIntentSender"</span>, <span class="keyword">new</span> startActivityIntentSender(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"startVoiceActivity"</span>, <span class="keyword">new</span> startVoiceActivity(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"startNextMatchingActivity"</span>, <span class="keyword">new</span> startNextMatchingActivity(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"startActivityFromRecents"</span>, <span class="keyword">new</span> startActivityFromRecents(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"finishActivity"</span>, <span class="keyword">new</span> finishActivity(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"registerReceiver"</span>, <span class="keyword">new</span> registerReceiver(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"broadcastIntent"</span>, <span class="keyword">new</span> broadcastIntent(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"unbroadcastIntent"</span>, <span class="keyword">new</span> unbroadcastIntent(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"getCallingPackage"</span>, <span class="keyword">new</span> getCallingPackage(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"getCallingActivity"</span>, <span class="keyword">new</span> getCallingActivity(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"getAppTasks"</span>, <span class="keyword">new</span> getAppTasks(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"addAppTask"</span>, <span class="keyword">new</span> addAppTask(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"getTasks"</span>, <span class="keyword">new</span> getTasks(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"getServices"</span>, <span class="keyword">new</span> getServices(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"getProcessesInErrorState"</span>, <span class="keyword">new</span> getProcessesInErrorState(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"getContentProvider"</span>, <span class="keyword">new</span> getContentProvider(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"getContentProviderExternal"</span>, <span class="keyword">new</span> getContentProviderExternal(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"removeContentProviderExternal"</span>, <span class="keyword">new</span> removeContentProviderExternal(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"publishContentProviders"</span>, <span class="keyword">new</span> publishContentProviders(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"getRunningServiceControlPanel"</span>, <span class="keyword">new</span> getRunningServiceControlPanel(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"startService"</span>, <span class="keyword">new</span> startService(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"stopService"</span>, <span class="keyword">new</span> stopService(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"stopServiceToken"</span>, <span class="keyword">new</span> stopServiceToken(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"setServiceForeground"</span>, <span class="keyword">new</span> setServiceForeground(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"bindService"</span>, <span class="keyword">new</span> bindService(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"publishService"</span>, <span class="keyword">new</span> publishService(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"unbindFinished"</span>, <span class="keyword">new</span> unbindFinished(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"peekService"</span>, <span class="keyword">new</span> peekService(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"bindBackupAgent"</span>, <span class="keyword">new</span> bindBackupAgent(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"backupAgentCreated"</span>, <span class="keyword">new</span> backupAgentCreated(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"unbindBackupAgent"</span>, <span class="keyword">new</span> unbindBackupAgent(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"killApplicationProcess"</span>, <span class="keyword">new</span> killApplicationProcess(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"startInstrumentation"</span>, <span class="keyword">new</span> startInstrumentation(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"getActivityClassForToken"</span>, <span class="keyword">new</span> getActivityClassForToken(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"getPackageForToken"</span>, <span class="keyword">new</span> getPackageForToken(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"getIntentSender"</span>, <span class="keyword">new</span> getIntentSender(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"clearApplicationUserData"</span>, <span class="keyword">new</span> clearApplicationUserData(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"handleIncomingUser"</span>, <span class="keyword">new</span> handleIncomingUser(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"grantUriPermission"</span>, <span class="keyword">new</span> grantUriPermission(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"getPersistedUriPermissions"</span>, <span class="keyword">new</span> getPersistedUriPermissions(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"killBackgroundProcesses"</span>, <span class="keyword">new</span> killBackgroundProcesses(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"forceStopPackage"</span>, <span class="keyword">new</span> forceStopPackage(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"getRunningAppProcesses"</span>, <span class="keyword">new</span> getRunningAppProcesses(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"getRunningExternalApplications"</span>, <span class="keyword">new</span> getRunningExternalApplications(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"getMyMemoryState"</span>, <span class="keyword">new</span> getMyMemoryState(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"crashApplication"</span>, <span class="keyword">new</span> crashApplication(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"grantUriPermissionFromOwner"</span>, <span class="keyword">new</span> grantUriPermissionFromOwner(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"checkGrantUriPermission"</span>, <span class="keyword">new</span> checkGrantUriPermission(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"startActivities"</span>, <span class="keyword">new</span> startActivities(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"getPackageScreenCompatMode"</span>, <span class="keyword">new</span> getPackageScreenCompatMode(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"setPackageScreenCompatMode"</span>, <span class="keyword">new</span> setPackageScreenCompatMode(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"getPackageAskScreenCompat"</span>, <span class="keyword">new</span> getPackageAskScreenCompat(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"setPackageAskScreenCompat"</span>, <span class="keyword">new</span> setPackageAskScreenCompat(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"navigateUpTo"</span>, <span class="keyword">new</span> navigateUpTo(mHostContext));</span><br><span class="line">        sHookedMethodHandlers.put(<span class="string">"serviceDoneExecuting"</span>, <span class="keyword">new</span> serviceDoneExecuting(mHostContext));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到在init中生成了很多类，而我们在invoke方法中就会根据对应的方法名拿到对应的类。</p>
<p>回想一下，我们在这里对应的是什么方法？根据前面的文章，我们知道是startActivity方法，进而拿到的是startActivity类。</p>
<p>回到invoke方法，拿到HookedMethodHandler后，会执行它的doInnerHook方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Object <span class="title">doHookInner</span><span class="params">(Object receiver, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> b = System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mUseFakedResult = <span class="keyword">false</span>;</span><br><span class="line">        mFakedResult = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">boolean</span> suc = beforeInvoke(receiver, method, args);</span><br><span class="line">        Object invokeResult = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (!suc) &#123;</span><br><span class="line">            invokeResult = method.invoke(receiver, args);</span><br><span class="line">        &#125;</span><br><span class="line">        afterInvoke(receiver, method, args, invokeResult);</span><br><span class="line">        <span class="keyword">if</span> (mUseFakedResult) &#123;</span><br><span class="line">            <span class="keyword">return</span> mFakedResult;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> invokeResult;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">long</span> time = System.currentTimeMillis() - b;</span><br><span class="line">        <span class="keyword">if</span> (time &gt; <span class="number">5</span>) &#123;</span><br><span class="line">            Log.i(TAG, <span class="string">"doHookInner method(%s.%s) cost %s ms"</span>, method.getDeclaringClass().getName(), method.getName(), time);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到这个方法也是AOP的，在真正的调用method.invoke之前和之后会对应的调用beforeInvoke和afterInvoke。这两个方法是有待HookedMethodHandler的子类去实现的，这里是startActivity这个子类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">beforeInvoke</span><span class="params">(Object receiver, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"></span><br><span class="line">    RunningActivities.beforeStartActivity();</span><br><span class="line">    <span class="keyword">boolean</span> bRet;</span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.JELLY_BEAN_MR2) &#123;</span><br><span class="line">        bRet = doReplaceIntentForStartActivityAPILow(args);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        bRet = doReplaceIntentForStartActivityAPIHigh(args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!bRet) &#123;</span><br><span class="line">        setFakedResult(Activity.RESULT_CANCELED);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.beforeInvoke(receiver, method, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据sdk版本进入不同的方法，这里我们只看APIHigh。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">doReplaceIntentForStartActivityAPIHigh</span><span class="params">(Object[] args)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> intentOfArgIndex = findFirstIntentIndexInArgs(args);</span><br><span class="line">            <span class="keyword">if</span> (args != <span class="keyword">null</span> &amp;&amp; args.length &gt; <span class="number">1</span> &amp;&amp; intentOfArgIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                Intent intent = (Intent) args[intentOfArgIndex];</span><br><span class="line">                <span class="comment">//XXX String callingPackage = (String) args[1];</span></span><br><span class="line">                <span class="keyword">if</span> (!PluginPatchManager.getInstance().canStartPluginActivity(intent)) &#123;</span><br><span class="line">                    PluginPatchManager.getInstance().startPluginActivity(intent);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                ActivityInfo activityInfo = resolveActivity(intent);</span><br><span class="line">                <span class="keyword">if</span> (activityInfo != <span class="keyword">null</span> &amp;&amp; isPackagePlugin(activityInfo.packageName)) &#123;</span><br><span class="line">                    ComponentName component = selectProxyActivity(intent);</span><br><span class="line">                    <span class="keyword">if</span> (component != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        Intent newIntent = <span class="keyword">new</span> Intent();</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            ClassLoader pluginClassLoader = PluginProcessManager.getPluginClassLoader(component.getPackageName());</span><br><span class="line">                            setIntentClassLoader(newIntent, pluginClassLoader);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                            Log.w(TAG, <span class="string">"Set Class Loader to new Intent fail"</span>, e);</span><br><span class="line">                        &#125;</span><br><span class="line">                        newIntent.setComponent(component);</span><br><span class="line">                        newIntent.putExtra(Env.EXTRA_TARGET_INTENT, intent);</span><br><span class="line">                        newIntent.setFlags(intent.getFlags());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                        String callingPackage = (String) args[<span class="number">1</span>];</span><br><span class="line">                        <span class="keyword">if</span> (TextUtils.equals(mHostContext.getPackageName(), callingPackage)) &#123;</span><br><span class="line">                        newIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">                        args[intentOfArgIndex] = newIntent;</span><br><span class="line">                        args[<span class="number">1</span>] = mHostContext.getPackageName();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        Log.w(TAG, <span class="string">"startActivity,replace selectProxyActivity fail"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>又是一个逻辑比较多的方法，但是很好理解，其实和Small做的事是差不多的，就是生成一个占坑的Intent，把真正的activity当作参数放在Intent中。</p>
<p>到这儿，就完成了第一步，我们要做的就是在对应的地方Hook掉这个AMS，至于怎么Hook大家自己去看源码，Hook的技巧不是重点，重点是Hook了什么。</p>
<p>那DroidPlugin是在哪里把Activity还原了呢？回想一下前文startActivity步骤6：</p>
<p>(6) 通过ActivityThread中的H（一个handler）传递消息，最终调用Instrumentation来创建一个Activity。</p>
<p>通过Handler去传递消息，让我们看看Handler的源码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msg.callback != <span class="keyword">null</span>) &#123;</span><br><span class="line">        handleCallback(msg);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mCallback.handleMessage(msg)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        handleMessage(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在dispatchMessage中，有一个CallBack，如果它不为空，就使用它去处理而不走Handler的handleMessage方法。DroidPlugin正是利用了这一点，自己去生成了一个CallBack并且通过反射注入到了ActivityThread的H类中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	 <span class="keyword">if</span> (msg.what == LAUNCH_ACTIVITY) &#123;</span><br><span class="line">                <span class="keyword">return</span> handleLaunchActivity(msg);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     ...........</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是对应CallBack的handleMessage方法，如果message是LAUNCH_ACTIVITY，直接调用了handleLaunchActivity方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">handleLaunchActivity</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Object obj = msg.obj;</span><br><span class="line">        Intent stubIntent = (Intent) FieldUtils.readField(obj, <span class="string">"intent"</span>);</span><br><span class="line">        <span class="comment">//ActivityInfo activityInfo = (ActivityInfo) FieldUtils.readField(obj, "activityInfo", true);</span></span><br><span class="line">        stubIntent.setExtrasClassLoader(mHostContext.getClassLoader());</span><br><span class="line">        Intent targetIntent = stubIntent.getParcelableExtra(Env.EXTRA_TARGET_INTENT);</span><br><span class="line">        <span class="comment">// 这里多加一个isNotShortcutProxyActivity的判断，因为ShortcutProxyActivity的很特殊，启动它的时候，</span></span><br><span class="line">        <span class="comment">// 也会带上一个EXTRA_TARGET_INTENT的数据，就会导致这里误以为是启动插件Activity，所以这里要先做一个判断。</span></span><br><span class="line">        <span class="comment">// 之前ShortcutProxyActivity错误复用了key，但是为了兼容，所以这里就先这么判断吧。</span></span><br><span class="line">        <span class="keyword">if</span> (targetIntent != <span class="keyword">null</span> &amp;&amp; !isShortcutProxyActivity(stubIntent)) &#123;</span><br><span class="line">            IPackageManagerHook.fixContextPackageManager(mHostContext);</span><br><span class="line">            ComponentName targetComponentName = targetIntent.resolveActivity(mHostContext.getPackageManager());</span><br><span class="line">            ActivityInfo targetActivityInfo = PluginManager.getInstance().getActivityInfo(targetComponentName, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (targetActivityInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (targetComponentName != <span class="keyword">null</span> &amp;&amp; targetComponentName.getClassName().startsWith(<span class="string">"."</span>)) &#123;</span><br><span class="line">                    targetIntent.setClassName(targetComponentName.getPackageName(), targetComponentName.getPackageName() + targetComponentName.getClassName());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ResolveInfo resolveInfo = mHostContext.getPackageManager().resolveActivity(stubIntent, <span class="number">0</span>);</span><br><span class="line">                ActivityInfo stubActivityInfo = resolveInfo != <span class="keyword">null</span> ? resolveInfo.activityInfo : <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (stubActivityInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    PluginManager.getInstance().reportMyProcessName(stubActivityInfo.processName, targetActivityInfo.processName, targetActivityInfo.packageName);</span><br><span class="line">                &#125;</span><br><span class="line">                PluginProcessManager.preLoadApk(mHostContext, targetActivityInfo);</span><br><span class="line">                ClassLoader pluginClassLoader = PluginProcessManager.getPluginClassLoader(targetComponentName.getPackageName());</span><br><span class="line">                setIntentClassLoader(targetIntent, pluginClassLoader);</span><br><span class="line">                setIntentClassLoader(stubIntent, pluginClassLoader);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    targetIntent.putExtra(Env.EXTRA_TARGET_INFO, targetActivityInfo);</span><br><span class="line">                    <span class="keyword">if</span> (stubActivityInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        targetIntent.putExtra(Env.EXTRA_STUB_INFO, stubActivityInfo);</span><br><span class="line">                    &#125;</span><br><span class="line">                    success = <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    Log.e(TAG, <span class="string">"putExtra 1 fail"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!success &amp;&amp; Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.KITKAT) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        ClassLoader oldParent = fixedClassLoader(pluginClassLoader);</span><br><span class="line">                        targetIntent.putExtras(targetIntent.getExtras());</span><br><span class="line"></span><br><span class="line">                        targetIntent.putExtra(Env.EXTRA_TARGET_INFO, targetActivityInfo);</span><br><span class="line">                        <span class="keyword">if</span> (stubActivityInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            targetIntent.putExtra(Env.EXTRA_STUB_INFO, stubActivityInfo);</span><br><span class="line">                        &#125;</span><br><span class="line">                        fixedClassLoader(oldParent);</span><br><span class="line">                        success = <span class="keyword">true</span>;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        Log.e(TAG, <span class="string">"putExtra 2 fail"</span>, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">                    Intent newTargetIntent = <span class="keyword">new</span> Intent();</span><br><span class="line">                    newTargetIntent.setComponent(targetIntent.getComponent());</span><br><span class="line">                    newTargetIntent.putExtra(Env.EXTRA_TARGET_INFO, targetActivityInfo);</span><br><span class="line">                    <span class="keyword">if</span> (stubActivityInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        newTargetIntent.putExtra(Env.EXTRA_STUB_INFO, stubActivityInfo);</span><br><span class="line">                    &#125;</span><br><span class="line">                    FieldUtils.writeDeclaredField(msg.obj, <span class="string">"intent"</span>, newTargetIntent);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    FieldUtils.writeDeclaredField(msg.obj, <span class="string">"intent"</span>, targetIntent);</span><br><span class="line">                &#125;</span><br><span class="line">                FieldUtils.writeDeclaredField(msg.obj, <span class="string">"activityInfo"</span>, targetActivityInfo);</span><br><span class="line"></span><br><span class="line">                Log.i(TAG, <span class="string">"handleLaunchActivity OK"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Log.e(TAG, <span class="string">"handleLaunchActivity oldInfo==null"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">"handleLaunchActivity targetIntent==null"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">"handleLaunchActivity FAIL"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> mCallback.handleMessage(msg);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码依旧很长，但是核心就是拿到真正的Activity并且创建。</p>
<p>至此，DroidPlugin的逻辑也就理完了，和Small不同，它是hook了整个AMS并且通过反射替换了H类的CallBack，做到了［瞒天过海］。</p>
<h1 id="两种方式的比较"><a href="#两种方式的比较" class="headerlink" title="两种方式的比较"></a>两种方式的比较</h1><p>那么这两种方式孰优孰劣呢？</p>
<p>我认为，DroidPlugin的方式是更加［屌］的，大家可以看上面IActivityManagerHookHandle这个类，在init方法中put的那些类，和Activity相关的只有一小部分，更多的是service，broadcast等等的操作。这是Small使用［Hook Instrumentation］所做不到的，因为Instrumentation只是Activity的管家，如果涉及到service这样的，它就无能为力了。</p>
<p>但是从另外一个方面说，Service的动态注册这样的需求其实是不多的，Hook Instrumentation基本已能满足大部分的场景的，另外Hook AMS需要的知识储备是要多得多的，拿我来说吧，看DroidPlugin的源码比看Small的源码困难太多了。。</p>
<p>这些都是要大家自己斟酌的。</p>

      
    </div>

    <div>
      
        
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/plugin/" rel="tag">#plugin</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/05/03/其实没那么复杂！探究react-native通信机制/" rel="next" title="其实没那么复杂！探究react-native通信机制">
                <i class="fa fa-chevron-left"></i> 其实没那么复杂！探究react-native通信机制
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/05/10/从Instant-Run出发，谈谈Android上的热修复/" rel="prev" title="">
                 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.png"
               alt="zjutkz" />
          <p class="site-author-name" itemprop="name">zjutkz</p>
          <p class="site-description motion-element" itemprop="description">写下结果因为人们爱追溯，省略过程因为时间爱催促。</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">45</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">31</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        <div class="links-of-blogroll motion-element">
          
        </div>

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator">
            <i class="fa fa-angle-double-up"></i>
          </div>
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#插件化介绍"><span class="nav-number">2.</span> <span class="nav-text">插件化介绍</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#原理分析"><span class="nav-number">3.</span> <span class="nav-text">原理分析</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#思考解决方案"><span class="nav-number">4.</span> <span class="nav-text">思考解决方案</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Small实现方式"><span class="nav-number">5.</span> <span class="nav-text">Small实现方式</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#DroidPlugin实现方式"><span class="nav-number">6.</span> <span class="nav-text">DroidPlugin实现方式</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#两种方式的比较"><span class="nav-number">7.</span> <span class="nav-text">两种方式的比较</span></a></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator">
            <i class="fa fa-angle-double-down"></i>
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zjutkz</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  


  




<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/lib/velocity/velocity.min.js"></script>

  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=0.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=0.5.0"></script>



  
  

  
  
<script type="text/javascript" src="/js/src/scrollspy.js?v=0.5.0"></script>

<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 1 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = NexT.utils.escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    NexT.motion.middleWares.sidebar = function () {
      var $tocContent = $('.post-toc-content');

      if (CONFIG.sidebar.display === 'post' || CONFIG.sidebar.display === 'always') {
        if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
          NexT.utils.displaySidebar();
        }
      }
    };
  });
</script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=0.5.0"></script>



  



  



  
  
  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("NW3PqfRBQc5fFTl1qj3NHoIz-gzGzoHsz", "6yROqDeLiKrgr5XOqHenkt7m");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

</body>
</html>
